<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GPS App JOS</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">
  <style>
      #map {
        height: 400px;
        width: 100%;
       }
    </style>
  <!-- <link rel="stylesheet" href="css/styles.css?v=1.0"> -->

  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
</head>
<body>
  <h1> JOS Map App </h1>
  <button>Send an HTTP GET request to a page and get the result back</button>
  <script type="text/javascript" src = "js/jquery-3.2.1.min.js"></script>
  <div id="map"></div>
  <script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAix3M854--ZyLZTmhKKFkoodebroJTUP8&libraries=geometry,drawing,places">
  </script>
  <script>
  // Make a get request to the server using ajax.
  // Then get the latitude and longitude from the json string.
  $(document).ready(function(){
    setTimeout(function() {
      $("#button").trigger('click');
    }, 5000);

    $("button").click(function(){

      $.ajax({
          url: "http://pure-hollows-72424.herokuapp.com",
          type: 'GET',
          success: function(data){
            var points = new Array();
            var userPoint;
            if(data.length == 0){
              $("#error").html("Oops, no data on the requested bus :(");
            }
            else {
              for(var i=0; i < data.length; i++) {
                points[i] = new google.maps.LatLng(parseFloat(data[i].latitude).toFixed(3), parseFloat(data[i].longitude).toFixed(3))
              }
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    console.log(position.coords.latitude)
                    userPoint = new google.maps.LatLng(parseFloat(position.coords.latitude), parseFloat(position.coords.longitude))
                    initMap(points, userPoint)
                });
              }
            }
          },
          error: function(data) {
            alert('it seems the server is unresponsive, please try again later');
          }
      });

    });
  });

  function initMap(points, userPoint) {
    var uluru = points[(points.length)-1];  //the last point recorded
    var distanceToUser = google.maps.geometry.spherical.computeDistanceBetween(uluru, userPoint)
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 6,
      center: uluru,
    });

    var marker = new google.maps.Marker({
      position: uluru,
      map: map
    });

    var pathCoords = points
    var flightPath = new google.maps.Polyline({
        path: pathCoords,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
    });
    runSnapToRoad(flightPath)
    // flightPath.setMap(map);
    if(userPoint == 0) {
      $("#distance").html("I can't get your position, but you can track the bus above")
    }
    else {
      $("#distance").html("The bus is " + distanceToUser + " meters away")
    }
  }

  function runSnapToRoad(path) {
    var pathValues = [];
    var len = google.maps.geometry.spherical.computeLength(path.getPath())
    for (var i = 0; i < len; i++) {
      pathValues.push(path.getAt(i).toUrlValue());
    }
    $.get('https://roads.googleapis.com/v1/snapToRoads', {
      interpolate: true,
      key: 'AIzaSyAix3M854--ZyLZTmhKKFkoodebroJTUP8',
      path: pathValues.join('|')
    }, function(data) {
      processSnapToRoadResponse(data);
      drawSnappedPolyline();
    });
  }
  function processSnapToRoadResponse(data) {
    snappedCoordinates = [];
    placeIdArray = [];
    for (var i = 0; i < data.snappedPoints.length; i++) {
      var latlng = new google.maps.LatLng(
        data.snappedPoints[i].location.latitude,
        data.snappedPoints[i].location.longitude);
        snappedCoordinates.push(latlng);
        placeIdArray.push(data.snappedPoints[i].placeId);
      }
  }

  function drawSnappedPolyline() {
    var snappedPolyline = new google.maps.Polyline({
      path: snappedCoordinates,
      strokeColor: 'black',
      strokeWeight: 3
    });
    snappedPolyline.setMap(map);
    polylines.push(snappedPolyline);
  }
  </script>
  <!-- <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAix3M854--ZyLZTmhKKFkoodebroJTUP8&callback=initMap">
  </script> -->
  <div id="error"></div>
  <div id="distance"></div>
</body>
</html>
